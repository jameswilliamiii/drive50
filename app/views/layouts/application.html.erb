<!DOCTYPE html>
<html>
  <head>
    <title>Drive50</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body class="<%= 'has-bottom-nav' if authenticated? %>" <% if authenticated? %>data-controller="drawer" data-action="click@window->drawer#handleClickOutside"<% end %>>
    <header>
      <div class="container">
        <div class="header-content">
          <h1><%= link_to "Drive50", root_path %></h1>
          <% if authenticated? %>
            <div class="header-nav">
              <button type="button" class="menu-button" data-drawer-target="button" data-action="click->drawer#toggle" aria-label="Toggle menu" aria-expanded="false">
                <%= icon_menu(size: 24, class: "menu-icon") %>
              </button>
              <!-- Drawer for desktop dropdown -->
              <div class="drawer-backdrop drawer-backdrop-desktop" data-drawer-target="backdrop" data-action="click->drawer#handleBackdropClick"></div>
              <nav class="drawer drawer-desktop" data-drawer-target="drawer">
                <div class="drawer-content" data-action="click->drawer#handleMenuItemClick">
                  <%= button_to "Start New Drive", drive_sessions_path,
                                method: :post,
                                class: "drawer-item drawer-item-primary",
                                form: { style: "display: inline;" } %>
                  <%= link_to "All Drives", all_drive_sessions_path, class: "drawer-item" %>
                  <%= link_to "Export Log", export_drive_sessions_path(format: :csv), class: "drawer-item" %>
                  <%= link_to "Edit Profile", edit_user_path, class: "drawer-item" %>
                  <hr class="drawer-divider">
                  <%= link_to "Sign Out", session_path, method: :delete, class: "drawer-item drawer-item-danger" %>
                </div>
              </nav>
            </div>
          <% else %>
            <div class="header-nav" data-controller="menu" data-action="click@window->menu#handleClickOutside">
              <button type="button" class="menu-button" data-menu-target="button" data-action="click->menu#toggle" aria-label="Toggle menu" aria-expanded="false">
                <%= icon_menu(size: 24, class: "menu-icon") %>
              </button>
              <nav class="menu" data-menu-target="menu">
                <%= link_to "Sign In", new_session_path, class: "menu-item" %>
                <%= link_to "Sign Up", new_registration_path, class: "menu-item menu-item-primary" %>
              </nav>
            </div>
          <% end %>
        </div>
      </div>
    </header>

    <% if authenticated? %>
      <!-- Slide-out Drawer for Mobile -->
      <div class="drawer-backdrop drawer-backdrop-mobile" data-drawer-target="backdrop" data-action="click->drawer#handleBackdropClick"></div>
      <nav class="drawer drawer-mobile" data-drawer-target="drawer">
        <div class="drawer-content" data-action="click->drawer#handleMenuItemClick">
          <%= link_to "All Drives", all_drive_sessions_path, class: "drawer-item" %>
          <%= link_to "Export Log", export_drive_sessions_path(format: :csv), class: "drawer-item" %>
          <%= link_to "Edit Profile", edit_user_path, class: "drawer-item" %>
          <hr class="drawer-divider">
          <%= link_to "Sign Out", session_path, method: :delete, class: "drawer-item" %>
        </div>
      </nav>

      <!-- Bottom Navigation Bar -->
      <nav class="bottom-nav">
        <%= link_to root_path, class: "bottom-nav-item #{'active' if request.path == root_path}" do %>
          <%= icon_home(size: 24, class: "bottom-nav-icon") %>
          <span class="bottom-nav-label">Home</span>
        <% end %>
        <%= button_to drive_sessions_path, method: :post, class: "bottom-nav-item", form: { class: "bottom-nav-form" } do %>
          <%= icon_plus(size: 24, class: "bottom-nav-icon") %>
          <span class="bottom-nav-label">New Drive</span>
        <% end %>
        <button type="button" class="bottom-nav-item" data-drawer-target="button" data-action="click->drawer#toggle" aria-label="Toggle menu" aria-expanded="false">
          <%= icon_menu(size: 24, class: "bottom-nav-icon") %>
          <span class="bottom-nav-label">Menu</span>
        </button>
      </nav>
    <% end %>

    <div class="toast-container" id="toast-container">
      <% if notice.present? %>
        <div class="toast toast-success"
             data-controller="toast"
             data-toast-type-value="success"
             data-toast-duration-value="5000">
          <div class="toast-content"><%= notice %></div>
          <button type="button" class="toast-close" data-action="click->toast#close" aria-label="Close"></button>
        </div>
      <% end %>

      <% if alert.present? %>
        <div class="toast toast-error"
             data-controller="toast"
             data-toast-type-value="error"
             data-toast-duration-value="6000">
          <div class="toast-content"><%= alert %></div>
          <button type="button" class="toast-close" data-action="click->toast#close" aria-label="Close"></button>
        </div>
      <% end %>
    </div>

    <main>
      <div class="container">
        <%= yield %>
      </div>
    </main>
  </body>
</html>
